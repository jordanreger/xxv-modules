<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"
    />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=DM+Mono:ital@0;1&family=DM+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@400;500;600&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Mono:ital@0;1&family=DM+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Mono:ital@0;1&family=DM+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@400;500;600&display=swap" />
    </noscript>

    <style>
      #app {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: #212121;
        overflow: hidden;
      }

      .main-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: grid;
        grid-auto-columns: 1fr;
        grid-auto-rows: 1fr;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 11fr;
        gap: 0px 1em;
        grid-template-areas:
          "toolbar"
          "canvas";
      }

      .toolbar-placeholder {
        grid-area: toolbar;
        background: #0f0f0f;
        border-bottom: 2px solid #424242;
      }

      .canvas {
        background: #212121;
        grid-area: canvas;
        z-index: 2;
      }
    </style>
  </head>

  <script name="canvas" type="module">
    import {LitElement, html, css} from "https://esm.sh/lit";

    class canvas extends LitElement {
      static styles = css`
        #menu {
          display: none;
          position: absolute;
          z-index: 10;
          width: 225px;
          height: max-content;
          overflow: visible;
          background-color: #313131;
          border: 2px solid #696969;
          border-radius: 10px;
          box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        #options {
          position: block;
          margin: 0.75rem;
          width: calc(100% - 1.5rem);
        }

        #option {
          color: #c4c4c4;
          font-family: DM Mono;
          font-weight: 500;
          font-size: 1rem;
          padding: 1vh;
          height: max-content;
          border-radius: 5px;
          cursor: pointer;
          user-select: none;
        }

        #option:hover {
          background-color: #424242;
        }

        .container {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          display: grid;
          grid-auto-columns: 1fr;
          grid-auto-rows: 1fr;
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 11fr;
          gap: 0px 1em;
          grid-template-areas:
            "toolbar"
            "canvas";
        }

        .toolbar {
          grid-area: toolbar;
          border-bottom: 2px solid #424242;
        }

        .canvas {
          grid-area: canvas;
        }
      `;

      firstUpdated() {
        var mobile = "ontouchstart" in window;
        if(!mobile){
          window.addEventListener("contextmenu", this.openmenu);
          window.addEventListener("click", this.closemenu);
        }
      }

      constructor() {
        super();
        this.x = 0;
        this.y = 0;
      }

      openmenu(e) {
        e.preventDefault();
        var menu = document
          .querySelector("fx-canvas")
          .shadowRoot.getElementById("menu");
        menu.style.display = "block";
        let height = menu.offsetHeight, width = 225;
        this.x = e.clientX;
        this.y = e.clientY;
        let outsideX = false;
        let outsideY = false;
        if (e.clientX > window.innerWidth - width) {
          outsideX = true;
        }
        if (e.clientY > window.innerHeight - height) {
          outsideY = true;
        }
        if (!outsideX && !outsideY) {
          menu.style.left = `${this.x}px`;
          menu.style.top = `${this.y}px`;
        } else {
          if (outsideX && outsideY) {
            menu.style.left = `${window.innerWidth - (width + 5)}px`;
            menu.style.top = `${window.innerHeight - (height + 2)}px`;
          } else {
            if (outsideX) {
              menu.style.left = `${window.innerWidth - (width + 5)}px`;
              menu.style.top = `${this.y}px`;
            }
            if (outsideY) {
              menu.style.left = `${this.x}px`;
              menu.style.top = `${window.innerHeight - (height + 2)}px`;
            }
          }
        }
      }

      closemenu(e) {
        var menu = document
          .querySelector("fx-canvas")
          .shadowRoot.getElementById("menu");
        let height = menu.offsetHeight, width = 225;
        if (menu.style.display === "block") {
          let insideX = this.x + width;
          let insideY = this.y + height;
          let inside = false;
          if (e.clientX >= this.x && e.clientX <= insideX) {
            if (e.clientY >= this.y && e.clientY <= insideY) {
              inside = true;
            }
          }
          if (!inside) {
            e.preventDefault();
            menu.style.display = "none";
          }
        }
      }

      spawnRect(e){
        const fxCanvas = document.getElementsByTagName("fx-canvas")[0], canvas = fxCanvas.shadowRoot.getElementById("canvas");

        console.log(canvas);

        this.closemenu(e);
      }

      render() {
        return html`
          <div class="container">
            <div class="toolbar"></div>
            <div class="canvas" id="canvas">
              <div id="menu">
                <div id="options">
                  <div id="option" @click="${ this.spawnRect }">new:rectangle</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    }
    customElements.get("fx-canvas") || customElements.define("fx-canvas", canvas);
  </script>
  <main id="app">
    <div class="main-container">
      <div class="toolbar-placeholder"></div>
      <fx-canvas class="canvas"></fx-canvas>
    </div>

  </main>
</html>
